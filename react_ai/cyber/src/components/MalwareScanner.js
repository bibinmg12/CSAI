// import React, { useState, useEffect } from 'react';
// import axios from 'axios';
// import { FaCloudUploadAlt, FaFileAlt, FaHistory, FaShieldAlt } from 'react-icons/fa';
// import Footer from './footer';
// import Header from './header';
// import Modal from 'react-modal';
// Modal.setAppElement('#root');

// const MalwareScanner = () => {
//   const [file, setFile] = useState(null);
//   const [scanResult, setScanResult] = useState(null);
//   const [scanHistory, setScanHistory] = useState([]);
//   const [loading, setLoading] = useState(false);
//   const [errorMsg, setErrorMsg] = useState('');
//   const [selectedScan, setSelectedScan] = useState(null);

//   const handleFileChange = (e) => {
//     setFile(e.target.files[0]);
//   };

//   const handleScan = async () => {
//     if (!file) {
//       setErrorMsg('Please select a file to scan.');
//       return;
//     }

//     const formData = new FormData();
//     formData.append('file', file);

//     try {
//       setLoading(true);
//       setErrorMsg('');
//       const response = await axios.post('http://localhost:8000/scan-file/', formData, {
//         withCredentials: true,
//       });

//       setScanResult(response.data);
//       fetchScanHistory();
//     } catch (error) {
//       setErrorMsg(error.response?.data?.error || 'Scan failed.');
//     } finally {
//       setLoading(false);
//     }
//   };

//   const fetchScanHistory = async () => {
//     try {
//       const response = await axios.get('http://localhost:8000/scan-reports/', {
//         withCredentials: true,
//       });
//       setScanHistory(response.data.scans || []);
//     } catch (error) {
//       setErrorMsg('Failed to fetch scan history.');
//     }
//   };

//   useEffect(() => {
//     fetchScanHistory();
//   }, []);

  
//   return (
//     <>
//       <Header />
//       <div style={{ maxWidth: '800px', margin: 'auto', padding: '20px' }}>
//         <h2 style={{ textAlign: 'center', marginBottom: '30px', color: '#2c3e50' }}>
//           <FaShieldAlt style={{ marginRight: '10px' }} />
//           Malware Scanner (VirusTotal)
//         </h2>

//         <div
//           style={{
//             border: '2px dashed #4ca1af',
//             padding: '30px',
//             borderRadius: '12px',
//             textAlign: 'center',
//             background: '#f7f9fc',
//           }}
//         >
//           <FaCloudUploadAlt size={40} color="#4ca1af" />
//           <p style={{ margin: '10px 0', fontSize: '16px' }}>
//             {file ? (
//               <strong>Selected file: {file.name}</strong>
//             ) : (
//               'Drag and drop a file or click to select'
//             )}
//           </p>
//           <input type="file" onChange={handleFileChange} style={{ marginTop: '10px' }} />
//           <br />
//           <button
//             onClick={handleScan}
//             disabled={loading}
//             style={{
//               marginTop: '15px',
//               padding: '8px 16px',
//               background: '#4ca1af',
//               color: '#fff',
//               border: 'none',
//               borderRadius: '6px',
//               cursor: 'pointer',
//             }}
//           >
//             {loading ? 'Scanning...' : 'Scan File'}
//           </button>
//           {errorMsg && <p style={{ color: 'red', marginTop: '10px' }}>{errorMsg}</p>}
//         </div>

//         {scanResult && (
//           <div
//             style={{
//               background: '#e8f9e9',
//               marginTop: '25px',
//               borderRadius: '10px',
//               padding: '20px',
//               boxShadow: '0 0 10px rgba(0,0,0,0.1)',
//             }}
//           >
//             <h3 style={{ color: '#2e7d32' }}>âœ… Scan Completed</h3>
//             <p><strong>ðŸ“„ Filename:</strong> {scanResult.filename}</p>
//             <p><strong>ðŸ†” Scan ID:</strong> {scanResult.scan_id}</p>
//             <p><strong>ðŸ“Š Stats:</strong></p>
//             <ul>
//               {scanResult.stats &&
//                 Object.entries(scanResult.stats).map(([key, value]) => (
//                   <li key={key}>{key}: {value}</li>
//                 ))}
//             </ul>
//           </div>
//         )}

//         <hr style={{ margin: '40px 0' }} />

//         <h3 style={{ color: '#34495e' }}>
//           <FaHistory style={{ marginRight: '10px' }} />
//           Your Scan History
//         </h3>

//         {scanHistory.length === 0 ? (
//           <p>No previous scans found.</p>
//         ) : (
//           scanHistory.map((scan, idx) => {
//             const stats = scan.result?.data?.attributes?.stats || {};
//             const totalDetections = stats.malicious || 0;
//             const bgColor = totalDetections > 0 ? '#ffeaea' : '#e0f7fa';

//             return (
//               <div
//                 key={idx}
//                 style={{
//                   background: bgColor,
//                   padding: '15px',
//                   marginBottom: '15px',
//                   borderRadius: '10px',
//                   border: `1px solid ${totalDetections > 0 ? '#e74c3c' : '#1abc9c'}`,
//                 }}
//               >
//                 <p><FaFileAlt style={{ marginRight: '8px' }} /><strong>{scan.filename}</strong></p>
//                 <p>Scan ID: {scan.scan_id}</p>
//                 <p><strong>Stats:</strong></p>
//                 <ul>
//                   {Object.entries(stats).map(([key, value]) => (
//                     <li key={key}>{key}: {value}</li>
//                   ))}
//                 </ul>
//               </div>
//             );
//           })
//         )}
//       </div>
//       <Footer />
//     </>
//   );
// };

// export default MalwareScanner;




import React, { useState, useEffect } from 'react';
import axios from 'axios';
import { FaCloudUploadAlt, FaFileAlt, FaHistory, FaShieldAlt } from 'react-icons/fa';
import Footer from './footer';
import Header from './header';
import Modal from 'react-modal';

Modal.setAppElement('#root');

const MalwareScanner = () => {
  const [file, setFile] = useState(null);
  const [scanResult, setScanResult] = useState(null);
  const [scanHistory, setScanHistory] = useState([]);
  const [loading, setLoading] = useState(false);
  const [errorMsg, setErrorMsg] = useState('');
  const [selectedScan, setSelectedScan] = useState(null);

  const handleFileChange = (e) => {
    setFile(e.target.files[0]);
  };

  const handleScan = async () => {
    if (!file) {
      setErrorMsg('Please select a file to scan.');
      return;
    }

    const formData = new FormData();
    formData.append('file', file);

    try {
      setLoading(true);
      setErrorMsg('');
      const response = await axios.post('http://localhost:8000/scan-file/', formData, {
        withCredentials: true,
      });

      setScanResult(response.data);
      fetchScanHistory();
    } catch (error) {
      setErrorMsg(error.response?.data?.error || 'Scan failed.');
    } finally {
      setLoading(false);
    }
  };

  const fetchScanHistory = async () => {
    try {
      const response = await axios.get('http://localhost:8000/scan-reports/', {
        withCredentials: true,
      });
      setScanHistory(response.data.scans || []);
    } catch (error) {
      setErrorMsg('Failed to fetch scan history.');
    }
  };

  useEffect(() => {
    fetchScanHistory();
  }, []);

  return (
    <>
      <Header />
      {/* <div style={{ maxWidth: '800px', margin: 'auto', padding: '20px' }}> */}

      <div style={{ position: 'relative', minHeight: '100vh', overflow: 'hidden' }}>
  <video
    autoPlay
    loop
    muted
    playsInline
    style={{
      position: 'absolute',
      top: 0,
      left: 0,
      width: '100%',
      height: '100%',
      objectFit: 'cover',
      zIndex: -1,
    }}
  >
    <source src="/assets/user/images/bg_video1.mov" type="video/mp4" />
    Your browser does not support the video tag.
  </video>

  <div style={{ maxWidth: '800px', margin: 'auto', padding: '20px', background: 'rgba(255,255,255,0.92)', borderRadius: '12px' }}>

        <h2 style={{ textAlign: 'center', marginBottom: '30px', color: '#2c3e50' }}>
          <FaShieldAlt style={{ marginRight: '10px' }} />
          Malware Scanner (VirusTotal)
        </h2>

        <div
          style={{
            border: '2px dashed #4ca1af',
            padding: '30px',
            borderRadius: '12px',
            textAlign: 'center',
            background: '#f7f9fc',
          }}
        >
          <FaCloudUploadAlt size={40} color="#4ca1af" />
          <p style={{ margin: '10px 0', fontSize: '16px' }}>
            {file ? (
              <strong>Selected file: {file.name}</strong>
            ) : (
              'Drag and drop a file or click to select'
            )}
          </p>
          <input type="file" onChange={handleFileChange} style={{ marginTop: '10px' }} />
          <br />
          <button
            onClick={handleScan}
            disabled={loading}
            style={{
              marginTop: '15px',
              padding: '8px 16px',
              background: '#4ca1af',
              color: '#fff',
              border: 'none',
              borderRadius: '6px',
              cursor: 'pointer',
            }}
          >
            {loading ? 'Scanning...' : 'Scan File'}
          </button>
          {errorMsg && <p style={{ color: 'red', marginTop: '10px' }}>{errorMsg}</p>}
        </div>

        {scanResult && (
          <div
            style={{
              background: '#e8f9e9',
              marginTop: '25px',
              borderRadius: '10px',
              padding: '20px',
              boxShadow: '0 0 10px rgba(0,0,0,0.1)',
            }}
          >
            <h3 style={{ color: '#2e7d32' }}>âœ… Scan Completed</h3>
            <p><strong>ðŸ“„ Filename:</strong> {scanResult.filename}</p>
            <p><strong>ðŸ†” Scan ID:</strong> {scanResult.scan_id}</p>
            <p><strong>ðŸ“Š Stats:</strong></p>
            <ul>
              {scanResult.stats &&
                Object.entries(scanResult.stats).map(([key, value]) => (
                  <li key={key}>{key}: {value}</li>
                ))}
            </ul>
          </div>
        )}

        <hr style={{ margin: '40px 0' }} />

        <h3 style={{ color: '#34495e' }}>
          <FaHistory style={{ marginRight: '10px' }} />
          Your Scan History
        </h3>

        {/* MODAL FOR HISTORY DETAILS */}
        <Modal
          isOpen={!!selectedScan}
          onRequestClose={() => setSelectedScan(null)}
          contentLabel="Scan Details"
          style={{
            overlay: { backgroundColor: 'rgba(0, 0, 0, 0.6)' },
            content: {
              maxWidth: '600px',
              margin: 'auto',
              padding: '20px',
              borderRadius: '10px',
            },
          }}
        >
          {selectedScan && (
            <>
              <h2 style={{ marginBottom: '10px' }}>{selectedScan.filename}</h2>
              <p><strong>Scan ID:</strong> {selectedScan.scan_id}</p>
              <p><strong>Stats:</strong></p>
              <ul>
                {Object.entries(selectedScan.result?.data?.attributes?.stats || {}).map(([key, value]) => (
                  <li key={key}>{key}: {value}</li>
                ))}
              </ul>
              <button
                onClick={() => setSelectedScan(null)}
                style={{
                  marginTop: '20px',
                  padding: '8px 16px',
                  background: '#4ca1af',
                  color: '#fff',
                  border: 'none',
                  borderRadius: '6px',
                  cursor: 'pointer',
                }}
              >
                Close
              </button>
            </>
          )}
        </Modal>

        {/* CLICKABLE SCAN HISTORY CARDS */}
        {scanHistory.length === 0 ? (
          <p>No previous scans found.</p>
        ) : (
          <div style={{ display: 'flex', flexWrap: 'wrap', gap: '15px' }}>
            {scanHistory.map((scan, idx) => {
              const stats = scan.result?.data?.attributes?.stats || {};
              const totalDetections = stats.malicious || 0;
              const bgColor = totalDetections > 0 ? '#ffeaea' : '#e0f7fa';

              return (
                <div
                  key={idx}
                  onClick={() => setSelectedScan(scan)}
                  style={{
                    cursor: 'pointer',
                    background: bgColor,
                    padding: '12px 16px',
                    borderRadius: '10px',
                    border: `1px solid ${totalDetections > 0 ? '#e74c3c' : '#1abc9c'}`,
                    boxShadow: '0 2px 6px rgba(0,0,0,0.1)',
                    flex: '1 1 200px',
                  }}
                >
                  <p style={{ fontWeight: 'bold' }}>
                    <FaFileAlt style={{ marginRight: '6px' }} />
                    {scan.filename}
                  </p>
                  <p style={{ fontSize: '13px', color: '#555' }}>Scan ID: {scan.scan_id.slice(0, 15)}...</p>
                  <p style={{ fontSize: '12px' }}>
                    Malicious: <strong>{stats.malicious}</strong>
                  </p>
                </div>
              );
            })}
          </div>
        )}
      </div>
      </div>
      <Footer />
    </>
  );
};

export default MalwareScanner;
